name: Deploy Data to RDS

on:
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: perfect-car-picker
  DB_NAME: cardb
  DB_USER: ${{ secrets.TF_VAR_DB_USERNAME || 'adminuser' }}

permissions:
  contents: read

jobs:
  seed_database:
    name: Seed RDS Database
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        # Install libraries required by init_db.py
        pip install pandas sqlalchemy psycopg2-binary

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Infrastructure Lookup
      id: infra
      run: |
        echo "ðŸ” Finding Infrastructure..."
        
        # 1. Get EC2 Public IP (The Jump Host)
        # Filters by the tag Name=perfect-car-picker-web defined in terraform
        EC2_IP=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=${{ env.PROJECT_NAME }}-web" "Name=instance-state-name,Values=running" \
          --query "Reservations[*].Instances[*].PublicIpAddress" \
          --output text)
        
        # 2. Get RDS Endpoint (The Private Database)
        # Filters by DB Instance Identifier
        RDS_ENDPOINT=$(aws rds describe-db-instances \
          --db-instance-identifier ${{ env.DB_NAME }} \
          --query "DBInstances[0].Endpoint.Address" \
          --output text)
          
        echo "EC2_IP=$EC2_IP" >> $GITHUB_OUTPUT
        echo "RDS_ENDPOINT=$RDS_ENDPOINT" >> $GITHUB_OUTPUT
        
        echo "âœ… Found Jump Host: $EC2_IP"
        echo "âœ… Found Database: $RDS_ENDPOINT"

    - name: Setup SSH Tunnel
      env:
        SSH_AUTH_SOCK: /tmp/ssh_agent.sock
        SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        BASTION_HOST: ${{ steps.infra.outputs.EC2_IP }}
        RDS_HOST: ${{ steps.infra.outputs.RDS_ENDPOINT }}
      run: |
        # 1. Setup SSH Agent
        mkdir -p ~/.ssh
        ssh-keyscan -H $BASTION_HOST >> ~/.ssh/known_hosts
        echo "$SSH_KEY" > key.pem
        chmod 600 key.pem
        
        # 2. Open Tunnel in Background
        # Forwards local port 5432 -> EC2 -> RDS port 5432
        echo "ðŸ”Œ Opening Tunnel..."
        ssh -i key.pem -f -N -L 5432:$RDS_HOST:5432 ubuntu@$BASTION_HOST
        
        # 3. Wait for connection
        sleep 5
        echo "âœ… Tunnel Established"

    - name: Run Database Initialization
      env:
        DB_HOST: "127.0.0.1" 
        DB_PORT: "5432"
        DB_NAME: ${{ env.DB_NAME }}
        DB_USER: ${{ secrets.DB_USERNAME }}
        DB_PASS: ${{ secrets.DB_PASSWORD }}
      run: |
        echo "ðŸš€ Running init_db.py..."
        python init_db.py
        echo "âœ… Database Seeding Complete"